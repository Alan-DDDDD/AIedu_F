<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=
    , initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>
    <div class="m-3">
        <div class="form-floating">
            <textarea class="form-control" placeholder="Leave a comment here" id="question" style="height: 100px"></textarea>
            <label for="question">輸入問題</label>
        </div>
        <div class="mt-2">
            <input type="file" class="form-control" id="imgfile">
            <img class="mt-2" id="imagePreview" style="max-height: 300px;" />
        </div>
        <div class="mt-2">
            <button class="btn btn-primary p-1" id="send">解答</button>
            <div class="spinner-border text-primary" role="status" style="height: 1.25rem;width: 1.25rem;" id="loading">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <div class="card p-3 mt-2" id="answer">
        </div>
    </div>
        <script
        src="https://code.jquery.com/jquery-3.7.1.js"
        integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        $(`#loading`).attr('hidden',true);
        $(`#send`).on(`click`,async function(){
            $(`#loading`).removeAttr("hidden");
            let question = $(`#question`).val();
            let fileInput = $(`#imgfile`)[0];
            let form = new FormData();
            form.append('file',fileInput.files[0])
            let response = await fetch(`https://localhost:7009/api/OpenAI/ChatGPT?question=${question}&type=answer`,{
                method : "Post",
                body : form
            });
            let data = await response.text();
            $(`#answer`).html(data);
            $(`#loading`).attr('hidden',true);
        });
        // document.getElementById('imgfile').addEventListener('change', function(event) {
        //     const file = event.target.files[0];
        //     if (file) {
        //         const reader = new FileReader();

        //         // 當文件被讀取時執行
        //         reader.onload = function(e) {
        //             const img = document.getElementById('imagePreview');
        //             img.src = e.target.result; // 將圖片來源設為讀取的結果
        //             img.style.display = 'block'; // 顯示預覽圖片
        //         };

        //         // 讀取圖片檔案
        //         reader.readAsDataURL(file);
        //     }
        // });
        $('#imgfile').on('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.src = e.target.result;

                        img.onload = function() {
                            // 創建 Canvas
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');

                            // 設定 Canvas 尺寸
                            const MAX_WIDTH = 400; // 最大寬度
                            const MAX_HEIGHT = 400; // 最大高度
                            let width = img.width;
                            let height = img.height;

                            // 調整尺寸以符合最大寬度和高度
                            if (width > height) {
                                if (width > MAX_WIDTH) {
                                    height *= MAX_WIDTH / width;
                                    width = MAX_WIDTH;
                                }
                            } else {
                                if (height > MAX_HEIGHT) {
                                    width *= MAX_HEIGHT / height;
                                    height = MAX_HEIGHT;
                                }
                            }

                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);

                            // 壓縮圖片，這裡的品質可以調整
                            const quality = 1; // 壓縮品質 (0.0 到 1.0)
                            const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                            
                            // 顯示壓縮後的圖片
                            $('#imagePreview').attr('src', compressedDataUrl).show();
                            console.log(compressedDataUrl); // 可以在這裡查看壓縮後的 Base64 字串
                        };
                    };
                    reader.readAsDataURL(file);
                }
            });
    </script>
</body>
</html>